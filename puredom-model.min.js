/*! puredom-model 0.4.3 */
!function(a){"function"==typeof define&&define.amd?define(["puredom"],a):"object"==typeof module&&"function"==typeof require?module.exports=a(require("puredom")):window.puredom.Model=a(window.puredom)}(function(a){function b(){}function c(){return(Date.now()+Math.random()).toString(36).replace(".","-")}function d(e,f){var g=[].slice.call(arguments),h=this;return this!==a&&this instanceof d?(this.attributes={},a.EventEmitter.call(this),3===arguments.length&&(f=g[2],this.db=g[1]),f=f||b,e&&("string"==typeof e||"number"==typeof e?this.id=this.attributes.id=e:this.fromJSON(e)),void(this.id?this.fetch(f):(this.localId=c(),setTimeout(function(){h.fromCache(),f.call(h,null,h.attributes),h=null},1)))):new d(g[0],g[1],g[2])}return a.inherits(d,a.EventEmitter),a.extend(d.prototype,{type:"Model",url:"/api/{{type}}/{{id}}",idPath:"id",synced:!1,attributes:{},set:function(a,b){var c=this.attributes[a];this.attributes[a]=b,this.emit("change",[a,b,c]),this.cache(),this.sync()},get:function(a,b){return"function"==typeof b?this._fetchIfNotSynced(function(){b(this.attributes[a])}):this.attributes[a]},cache:function(a){var b=this.localId||this.id;return a=a||this.db,a&&a.setValue("$.Model."+this.type+"."+b,this.toJSON()),this},fromCache:function(a){var b=this.localId||this.id;return a=a||this.db,json=a&&b&&a.getValue("$.Model."+this.type+"."+b),json&&this.fromJSON(json),this},fetch:function(c){var d=this,e=this.toJSON();return c=c||b,this.emit("beforefetch, fetchstart",this),e.id=this.id||e.id,a.net.get(a.template(this.url,e),function(a,b){return a?(d.fromJSON(b),d.synced=!0,d.emit("fetch, fetchend",d),void c.call(d,null,b)):(d.emit("fetcherror",d),c.call(d,"Error: "+b,null))}),this},sync:function(c){var d,e=this;return c=c||b,this.initialized!==!0?c():(this.emit("beforesync, syncstart",this),d=this.toJSON(),delete d.localId,a.net.post(a.template(this.url,d),d,function(b,d){return b?(e.synced=!0,e.id=a.delve(d,e.idPath),e.emit("sync, syncend",e),void c.call(e,null,d)):(e.emit("syncerror",d),c.call(e,"Error: "+d,null))}),this)},_fetchIfNotSynced:function(a){var c=this;return a=a||b,this.synced===!0?setTimeout(function(){a.call(c,!0)},1):this.fetch(a)},toJSON:function(){return a.extend({},this.attributes)},fromJSON:function(b){return this.attributes=a.extend({},b),b.id?(this.id=b.id,this.localId&&(db.removeKey("$.Model."+this.type+"."+this.localId),delete this.localId,this.cache())):this.id||this.localId||!b.localId||(this.localId=b.localId,this.cache()),this}}),a.model=a.Model=d.Model=d,d});