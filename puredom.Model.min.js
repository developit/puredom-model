/*! puredom.Model 03-03-2014 */
!function(a){"function"==typeof window.define&&window.define.amd?window.define(["puredom"],a):a(window.puredom)}(function(a){function b(){}function c(){return(Date.now()+Math.random()).toString(36).replace(".","-")}function d(d,e){var f=[].slice.call(arguments),g=this;a.EventEmitter.call(this),3===arguments.length&&(e=f[2],this.db=f[1]),e=e||b,d&&("string"==typeof d||"number"==typeof d?this.id=this.attributes.id=d:this.fromJSON(d)),this.id?this.fetch(e):(this.localId=c(),setTimeout(function(){g.fromCache(),e(g),g=null},1))}return a.inherits(d,a.EventEmitter),a.extend(d.prototype,{type:"Model",url:"/api/{{type}}/{{id}}",synced:!1,attributes:{},set:function(a,b){var c=this.attributes[a];this.attributes[a]=b,this.fireEvent("change",[a,b,c]),this.cache(),this.sync()},get:function(a,b){return"function"==typeof b?this._fetchIfNotSynced(function(){b(this.attributes[a])}):this.attributes[a]},cache:function(a){var b=this.localId||this.id,c=a||this.db;return c&&c.setValue("$.Model."+this.type+"."+b,this.toJSON()),this},fromCache:function(a){var b=this.localId||this.id,c=a||this.db,d=c&&b&&c.getValue("$.Model."+this.type+"."+b);return d&&this.fromJSON(d),this},fetch:function(b){var c=this,d=this.toJSON();return this.fireEvent("fetchstart"),d.id=this.id||d.id,a.net.get(a.template(this.url,d),function(a,d){console.log("fetch() callback: ",a,d),a===!0&&(c.fromJSON(d),c.synced=!0),c.fireEvent("fetchend"),b.call(this,a?null:"Error: "+d,a?d:null)}),this},sync:function(c){var d,e=this;return c=c||b,this.initialized!==!0?c():(this.fireEvent("syncstart"),d=this.toJSON(),delete d.localId,a.net.post(a.template(this.url,d),d,function(a,b){console.log("sync() callback: ",arguments),e.synced=!0,e.fireEvent("syncend"),c.call(this,a?null:"Error: "+b,a?b:null)}),this)},_fetchIfNotSynced:function(a){var b=this;return this.synced===!0?setTimeout(function(){a.call(b,!0)},1):this.fetch(a)},toJSON:function(){return a.extend({},this.attributes)},fromJSON:function(b){return this.attributes=a.extend({},b),b.id?(this.id=b.id,this.localId&&(db.removeKey("$.Model."+this.type+"."+this.localId),delete this.localId,this.cache())):this.id||this.localId||!b.localId||(this.localId=b.localId,this.cache()),this}}),a.Model=d.Model=d,d});