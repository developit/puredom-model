/*! puredom.Model 01-07-2014 */
!function(a){"function"==typeof define&&define.amd?define(["puredom"],a):"object"==typeof module&&"function"==typeof require?module.exports=a(require("puredom")):window.puredom.Model=a(window.puredom)}(function(a){function b(){}function c(){return(Date.now()+Math.random()).toString(36).replace(".","-")}function d(d,e){var f=[].slice.call(arguments),g=this;a.EventEmitter.call(this),3===arguments.length&&(e=f[2],this.db=f[1]),e=e||b,d&&("string"==typeof d||"number"==typeof d?this.id=this.attributes.id=d:this.fromJSON(d)),this.id?this.fetch(e):(this.localId=c(),setTimeout(function(){g.fromCache(),e.call(g,null,g.attributes),g=null},1))}return a.inherits(d,a.EventEmitter),a.extend(d.prototype,{type:"Model",url:"/api/{{type}}/{{id}}",idPath:"id",synced:!1,attributes:{},set:function(a,b){var c=this.attributes[a];this.attributes[a]=b,this.emit("change",[a,b,c]),this.cache(),this.sync()},get:function(a,b){return"function"==typeof b?this._fetchIfNotSynced(function(){b(this.attributes[a])}):this.attributes[a]},cache:function(a){var b=this.localId||this.id,c=a||this.db;return c&&c.setValue("$.Model."+this.type+"."+b,this.toJSON()),this},fromCache:function(a){var b=this.localId||this.id,c=a||this.db,d=c&&b&&c.getValue("$.Model."+this.type+"."+b);return d&&this.fromJSON(d),this},fetch:function(c){var d=this,e=this.toJSON();return c=c||b,this.emit("beforefetch, fetchstart",this),e.id=this.id||e.id,a.net.get(a.template(this.url,e),function(a,b){return a?(d.fromJSON(b),d.synced=!0,d.emit("fetch, fetchend",d),void c.call(d,null,b)):(d.emit("fetcherror",d),c.call(d,"Error: "+b,null))}),this},sync:function(c){var d,e=this;return c=c||b,this.initialized!==!0?c():(this.emit("beforesync, syncstart",this),d=this.toJSON(),delete d.localId,a.net.post(a.template(this.url,d),d,function(b,d){return b?(e.synced=!0,e.id=a.delve(d,e.idPath),e.emit("sync, syncend",e),void c.call(e,null,d)):(e.emit("syncerror",d),c.call(e,"Error: "+d,null))}),this)},_fetchIfNotSynced:function(a){var c=this;return a=a||b,this.synced===!0?setTimeout(function(){a.call(c,!0)},1):this.fetch(a)},toJSON:function(){return a.extend({},this.attributes)},fromJSON:function(b){return this.attributes=a.extend({},b),b.id?(this.id=b.id,this.localId&&(db.removeKey("$.Model."+this.type+"."+this.localId),delete this.localId,this.cache())):this.id||this.localId||!b.localId||(this.localId=b.localId,this.cache()),this}}),a.Model=d.Model=d,d});